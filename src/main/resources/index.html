<!DOCTYPE html>
<html>

<head>
    <script data-require="jquery@*" data-semver="3.1.1" src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <style>
        #container {border: 1px solid brown;}
        H1 {float: left;}

         .button{
             background-color:#55A;
             border: 1px solid #229;
             width: 100px;
             float: right;
             font-size: 2em;
             color: white;
           }
        body {
            text-align: center;
        }
        .rTable {   	display: table;   	width: 100%; }
        .rTableRow {   	display: table-row; }
        .rTableHeading {   	display: table-header-group;   	background-color: #ddd; }
        #cancelButton{
            border-radius: 8px;
            background-color: grey;
        }
        #acceptButton{
            border-radius: 8px;
            background-color: red;
        }
        #recList {
            border: 1px solid green;
            clear: both;
        }
        .add-tag {
            border: 1px solid green;
            clear: both;
        }
        .receipt {
            display: table-row;
            background-color: #eee;
            margin-bottom: 5px;
        }
        .receiptPanel {
            display: none;
        }
        video {
            width: 400px;
            height: 300px;
            border: 1px solid black;
        }

        #vidwrap {
            margin: 20px 0;
        }

        #start, #snapshot {
            height: 3em;
        }
        .photoPanel {
          display: none
        }
    </style>
    <script>
        let imageCapture;

        function attachMediaStream(mediaStream) {
            $('video')[0].srcObject = mediaStream;

            // Saving the track allows us to capture a photo
            const track = mediaStream.getVideoTracks()[0];
            imageCapture = new ImageCapture(track);
        }
        $
        function startVideo() {
            navigator.mediaDevices.getUserMedia({video: {facingMode: {exact: "environment"}}})
                .then(attachMediaStream)
                .catch(error => {
                    navigator.mediaDevices.getUserMedia({video: true})
                        .then(attachMediaStream)
                        .catch(error => {
                            console.log('you are fooked');
                        })
                })
        }

        function takeSnapshot() {
            // create a CANVAS element that is same size as the image
            imageCapture.takePhoto()
                .then(blob => createImageBitmap(blob))
                .then(img => {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;

                    canvas.getContext('2d').drawImage(img, 0, 0);
                    const base64EncodedImageData = canvas.toDataURL('image/png').split(',')[1];
                    $.ajax({
                        url: "/images",
                        type: "POST",
                        data: base64EncodedImageData,
                        contentType: "text/plain",
                        success: function() {},
                   })
                    .then(response => {
                      console.log(response);
                      $('.photoPanel').hide();
                      $('#add-receipt').click();
                      console.log(response.merchantName);
                      console.log(response.amount);
                      $('#merchant').val(response.merchantName);
                      $('#amount').val(response.amount);
                      $('video').after(`<div>got response: <pre>${JSON.stringify(response)}</pre></div>`);
                    })
                    // .then(response => {
                    //     alert(response)

                    // })
                    .always(() => console.log('request complete'));

                    // For debugging, you can uncomment this to see the frame that was captured
                    // $('BODY').append(canvas);
                });

        }

        $(function () {
            $('#start').on('click', startVideo);
            $('video').on('play', () => $('#snapshot').prop('disabled', false));
            $('#snapshot').on('click', takeSnapshot);
        });


    </script>
    </head>
</head>

<body>
<DIV id="container">
    <h1>My receipts</h1>
    <div class="button" id="add-receipt">+</div>
    <div class="button" id="start-camera">
      <span class="glyphicon glyphicon-camera"></span>
    </div>
    <input type="text" id="merchant" class="receiptPanel" name="Merchant" amount="">
    <input type="text" id="amount" class="receiptPanel" name="Amount" amount="">
    <div class="button receiptButton receiptPanel" id="cancel-receipt">cancel</div>
    <div class="button receiptButton receiptPanel" id="save-receipt">save</div>
    <div class="rTable">
      <div class="rTableRow">
        <div class="rTableHeading">Time</div>
        <div class="rTableHeading">Merchant</div>
        <div class="rTableHeading">$</div>
        <div class="rTableHeading">Tag</div>
      </div>
    </div>

<button class="photoPanel" id="start">Start Video</button>
<button class="photoPanel" id="snapshot" disabled="true">Take a Snapshot!</button>
<button class="photoPanel" id="take-pic-cancel" disabled="true">cancel!</button>
<div class="photoPanel" id="vidwrap">
    <video autoplay></video>
</div>
</div>

</body>

<script>
    // This is the idiomatic way to ensure that JQuery does not
    // execute until the page has loaded

        const api = ""; // <- do not need a root api URL if this page is served directly by the API
        $(loadReceipts);

        function loadReceipts() {
        $("#receiptList").remove();
        $.getJSON(api+"/receipts", function(receipts){
          var items = [];
          $.each( receipts, function( key, val ) {
            items.push( "<div class= 'receipt' >");
            items.push( "<div class ='rTableCell'>" + val.created + "</div>" );
            items.push( "<div class='merchant rTableCell'>" + val.merchantName + "</div>" );
            items.push( "<div class='amount rTableCell'>" + val.value + "</div>" );
            $.each(val.tags,function (j, singleTag){
            items.push("<div id='" + key + j + " tag' class='tag tagValue rTableCell'>" + singleTag + "</div>");})
            items.push( "<div id='" + key + "' class='add-tag'>TAG IT!</div>" );
            items.push("<input type='text' id='" + key + "input' class='tag_input' style='display:none' name='tag' amount=''>");
            items.push( "</div>");
          })
          $( "<div/>", {
            "id": "receiptList",
            html: items.join( "" )
          }).appendTo( $("#container") );
          $(".add-tag").on("click",showTagInput);
          $(".tag_input").on("keypress",function(e){
            if(e.keyCode == 13){
              var tagName = $(this).val();
              key = parseInt($(this).attr('id').substring(0,1));
              $(updateTag(key+1,tagName));
            }

          });
          $(".tag").on("click",deleteTag);
        })
        }
    $('#start-camera').on('click',function(){
        $('.photoPanel').show();
    });
    $("#add-receipt").on("click",function(){
      $(".receiptPanel").show();
    });
    $("#cancel-receipt").on("click",cancelReceipt);
    function cancelReceipt(){
      $("input[type=text], textarea").val("");
      $(".receiptPanel").hide();
    }

    $("#save-receipt").on("click",saveReceipt);
    function saveReceipt(){
      var merchant = $("#merchant").val();
      var amount = $("#amount").val();
      $.ajax({
        type: "POST",
        url: api+"/receipts",
        data: JSON.stringify({"merchant": merchant, "amount": amount}),
        contentType: "application/json",
        success: function(data){$(loadReceipts)},
        failure: function(errMsg) {
          alert(errMsg);
        }
      })
      $("input[type=text], textarea").val("");
      $(".receiptPanel").hide();
    }

    function fxxkdamnbugs(){
      alert('fxxkdamnbugs');
    }

    function showTagInput(){
      key = $(this).attr('id');
      var inputId = "#"+key+"input"
      $(inputId).show();
    }



    function deleteTag(){
      var tagName = $(this).text();
      console.log(tagName)
      key = parseInt($(this).attr('id').substring(0,1));
      $(updateTag(key+1,tagName));
    }

    function updateTag(id,tagName){
      $.ajax({
        type: "PUT",
        url: api+'/tags/' + tagName,
        data: JSON.stringify(id),
        contentType: "application/json",
        success: function(data){$(loadReceipts)},
        failure: function(errMsg) {
          alert(errMsg);
        }
      });
    }

</script>

</html>
