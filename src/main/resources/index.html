<!DOCTYPE html>
<html>

<head>
    <script data-require="jquery@*" data-semver="3.1.1" src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <style>
        #container {border: 1px solid brown;}
        H1 {float: left;}

        .button{
            background-color:#55A;
            border: 1px solid #229;
            width: 100px;
            float: right;
            font-size: 2em;
            color: white;
            text-align: center;
        }
        #cancelButton{
            border-radius: 8px;
            background-color: grey;
        }
        #acceptButton{
            border-radius: 8px;
            background-color: red;
        }
        #recList {
            border: 1px solid green;
            clear: both;
        }
        .add-tag {
            border: 1px solid green;
            clear: both;
        }
        .receipt {
            background-color: #eee;
            margin-bottom: 5px;
        }
    </style>
    <script>
        // This is the idiomatic way to ensure that JQuery does not
        // execute until the page has loaded
        $(function(){
            const api = "http://localhost:8080"; // <- do not need a root api URL if this page is served directly by the API
            $(loadReceipts);
            function loadReceipts() {
            $(".receiptList").remove();
            $.getJSON(api+"/receipts", function(receipts){
              var items = [];
              $.each( receipts, function( key, val ) {
                var tags = [];
                $.each(val.tags,function (j, singleTag){
                tags.push("<div id='" + key + " tag' class='tag tagValue'>" + singleTag + "</div>");
                })
                items.push( "<div class='receipt'>")
                items.push( "<div id='" + key + "'>" + val.created + "</div>" );
                items.push( "<div id='" + key + "' class='merchant'>" + val.merchantName + "</div>" );
                items.push( "<div id='" + key + "' class='amount'>" + val.value + "</div>" );
                items.push(tags);
                //items.push( "<div id='" + key + " tag' class='tag tags'>" + val.tags + "</div>" );
                items.push( "<div id='" + key + "' class='add-tag'>TAG IT!</div>" );
                items.push("<input type='text' id='" + key + "input' class='tag_input' style='display:none' name='tag' amount=''>");
                items.push( "</div>")
                console.log(items);
              })
              $( "<div/>", {
                "class": "receiptList",
                html: items.join( "" )
              }).appendTo( $("#recList") );
              $(".add-tag").bind("click",showTagInput);
              $(".tag_input").bind("keypress",addTag);
              $(".tag").bind("click",deleteTag);
            })
            }
        $("#add-receipt").bind("click",showReceiptInput);
        function showReceiptInput(){
          $(".inputPanel").show();
        };
        $("#cancel-receipt").bind("click",cancelReceipt);
        function cancelReceipt(){
          $("input[type=text], textarea").val("");
          $(".inputPanel").hide();
        }
        $("#save-receipt").bind("click",saveReceipt);
        function saveReceipt(){
          var merchant = $("#merchant").val();
          var amount = $("#amount").val();
          $.ajax({
            type: "POST",
            url: api+"/receipts",
            data: JSON.stringify({"merchant": merchant, "amount": amount}),
            contentType: "application/json",
            success: function(data){$(loadReceipts)},
            failure: function(errMsg) {
              alert(errMsg);
            }
          })
          $("input[type=text], textarea").val("");
          $(".inputPanel").hide();
        }
        function fxxkdamnbugs(){
          alert('fxxkdamnbugs');
        }
        function showTagInput(){
          key = $(this).attr('id');
          var inputId = "#"+key+"input"
          $(inputId).show();
        }
        function addTag() {
          var tagName = $(this).val();
          key = parseInt($(this).attr('id').substring(0,1));
          $(updateTag(key+1,tagName));
        }
        function deleteTag(){
          var tagName = $(this).text();
          console.log(tagName)
          key = parseInt($(this).attr('id').substring(0,1));
          $(updateTag(key+1,tagName));
        }
        function updateTag(id,tagName){
          $.ajax({
            type: "PUT",
            url: api+'/tags/' + tagName,
            data: JSON.stringify(id),
            contentType: "application/json",
            success: function(data){$(loadReceipts)},
            failure: function(errMsg) {
              alert(errMsg);
            }
          });
        }
    })
    </script>
</head>

<body>
<DIV id="container">
    <h1>My receipts</h1>
    <div class="button" id="add-receipt">+</div>
    <div class="inputPanel" style="display:none">
      <input type="text" id="merchant" class="receiptPanel" name="Merchant" amount="">
      <input type="text" id="amount" class="receiptPanel" name="Amount" amount="">
      <div class="button receiptButton" id="cancel-receipt">cancel</div>
      <div class="button receiptButton" id="save-receipt">save</div>
    </div>
    <div id="recList">
      <div>Time</div>
      <div>Merchant</div>
      <div>$</div>
      <div>Tag</div>
    </div>
</DIV>
</body>

</html>
